# Evolution Fail-Safe — Progress

## Current Status
IN PROGRESS — F-001, F-002, F-003, F-004, F-005, F-006, F-007, F-008, F-009, F-010 completas (10/12). Proxima: F-011 hub-delete-flow-resilient.

## Specs Path
D:\sources\codr.studio\cia-prime-care\agentic-backbone\apps\backbone\milestones\05-evolution-failsafe

## Environment

### Stack
- Runtime: Node.js (ESM, TypeScript ES2022)
- Backend: Hono framework (apps/backbone)
- Frontend: React + TanStack Router + TanStack Query (apps/hub)
- Package manager: npm (workspaces monorepo)
- Docker: docker-compose.platform.yml (Postgres, Redis, Evolution API)

### Commands
- Dev (backbone): npm run dev:backbone (from root)
- Dev (hub): npm run dev:hub (from root)
- Dev (all): npm run dev:all (from root)
- Platform up: npm run platform:up (from root)
- Platform down: npm run platform:down (from root)
- Build hub: npm run build:hub (from root)
- E2E tests: npm run test:e2e (from root)

## Features

### Backbone (Response Contract)
- [x] F-001 backbone-response-helpers — Criar ok(), fail(), proxyGet() helpers
- [x] F-002 backbone-routes-envelope — Migrar todas as rotas para HTTP 200 com envelope

### Hub (Types & Infrastructure)
- [x] F-003 hub-api-types — ApiResult<T> type + mapa de mensagens amigaveis
- [x] F-004 hub-queries-envelope — Refatorar queries para interpretar envelope
- [x] F-005 hub-mutations-envelope — Refatorar mutations para retornar ApiResult

### Hub (Component Refactoring)
- [x] F-006 hub-create-dialog-separation — Dialog cria instancia -> aba status (nao QR)
- [x] F-007 hub-whatsapp-page-no-error-state — Pagina principal sem tela de erro
- [x] F-008 hub-instance-page-no-error-card — Pagina instancia sem InstanceErrorCard
- [x] F-009 hub-qr-component-resilient — QR resiliente com retry e reset
- [x] F-010 hub-settings-form-resilient — Settings form resiliente
- [ ] F-011 hub-delete-flow-resilient — Delete flow resiliente

### Validation
- [ ] F-012 smoke-test-end-to-end — Validacao final de todos os cenarios

## Architecture Decisions

1. **HTTP 200 Always**: Todas as rotas do modulo Evolution retornam HTTP 200. Erros de negocio (API offline, instancia nao encontrada, QR indisponivel) sao representados no body com { ok: false, error: "..." }. HTTP 4xx/5xx so ocorre se o backbone estiver genuinamente down.

2. **Separacao Instancia vs Linkagem**: Criar instancia nao navega para QR. A linkagem de telefone eh um processo independente acessado pela aba QR de uma instancia existente.

3. **Nao alterar lib/api.ts**: O ApiError continua existindo para falhas de rede reais (backbone inacessivel). Como o backbone nunca mais retorna 4xx/5xx, ApiError so dispara se o backbone estiver down.

4. **isError = rede, nao negocio**: No React Query, isError indica exclusivamente falha de rede. Erros de negocio sao tratados via result.ok no body da resposta.

5. **Helpers no backbone**: ok(), fail(), proxyGet() padronizam respostas e eliminam repeticao de try/catch em cada rota.

6. **Mensagens amigaveis**: Hub mantem mapa de error codes -> mensagens pt-BR para feedback ao usuario.

## Key Files

### Backbone
- apps/backbone/src/modules/evolution/routes.ts — Rotas do modulo Evolution (principal alvo)

### Hub
- apps/hub/src/api/evolution.ts — Types, queries, mutations
- apps/hub/src/lib/api.ts — HTTP client (NAO ALTERAR)
- apps/hub/src/pages/whatsapp.tsx — Pagina principal WhatsApp
- apps/hub/src/pages/whatsapp-instance.tsx — Pagina detalhe instancia
- apps/hub/src/components/connectivity/create-instance-dialog.tsx — Dialog criacao
- apps/hub/src/components/connectivity/instance-qr.tsx — Componente QR
- apps/hub/src/components/connectivity/instance-settings-form.tsx — Form settings

## Session Notes
Session 1 (Initializer): Harness criado para onda agenticbackbone-05-evolution-failsafe. 12 features decompostas do PRP. Foco em dois eixos: (1) padronizar contrato de resposta no backbone e (2) tornar hub resiliente a erros de negocio.

Session 2: Implementada F-001 backbone-response-helpers.
- Criados helpers ok(), fail(), proxyGet() em routes.ts
- Refatorado actionResultToResponse() para usar ok()/fail() — todas as respostas agora HTTP 200
- Corrigido bug de build em jobs/types.ts (adicionado "killed" ao JobStatus)
- Build limpo (backbone + hub tsc --noEmit)
- Proxima: F-002 backbone-routes-envelope (migrar todas as rotas para usar os helpers)

Session 3: Implementada F-002 backbone-routes-envelope.
- Migradas TODAS as rotas do modulo Evolution para HTTP 200 com envelope ok()/fail()
- GET /instances: api_offline retorna fail(), sucesso retorna ok(data)
- GET /instances/:name: api_offline e instance_not_found retornam fail(), sucesso retorna ok(data)
- POST /instances: validacao, criacao com sucesso retorna ok(data), falha retorna fail("create_failed")
- DELETE /instances/:name: falha retorna fail("delete_failed"), sucesso retorna ok(data)
- GET /instances/:name/qr: refatorado para usar proxyGet(), error code alterado de "qr_failed" para "qr_unavailable"
- GET /instances/:name/settings: refatorado para usar proxyGet()
- PATCH /instances/:name/settings: falha retorna fail("settings_update_failed"), sucesso retorna ok(data)
- POST reconnect/restart: offline e not_found usam fail(), actionResultToResponse ja usava ok()/fail()
- actionResultToResponse: corrigido sucesso de ok(c, { ok: true }) para ok(c, null) — evita envelope aninhado
- Smoke test via curl: todas as 10 rotas confirmadas retornando HTTP 200 com envelope correto
- Build limpo: backbone tsc + hub tsc --noEmit
- Proxima: F-003 hub-api-types

Session 3 (cont): Implementada F-003 hub-api-types.
- Adicionada interface ApiResult<T> com campos ok, data?, error?, details?, retryAfterMs?, attempts?, maxRetries?
- Adicionado mapa ERROR_MESSAGES com 10 error codes mapeados para mensagens pt-BR
- Adicionada funcao friendlyMessage() com fallback generico
- Build limpo: hub tsc --noEmit
- Proxima: F-004 hub-queries-envelope

Session 4: Implementada F-004 hub-queries-envelope.
- Refatoradas todas as queryFn em api/evolution.ts para interpretar envelope ApiResult<T>
- evolutionInstancesQuery: unwraps data ou retorna [] quando ok=false
- evolutionInstanceQuery: unwraps data ou retorna null quando ok=false
- evolutionInstanceSettingsQuery: unwraps data ou retorna null quando ok=false
- evolutionInstanceQRQuery: unwraps data ou retorna null quando ok=false
- evolutionHealthQuery: inalterada (rota /health nao usa envelope)
- Nenhuma queryFn lanca erro por erro de negocio — isError so dispara por falha de rede
- Consumidores ja usam optional chaining e defaults, 0 mudancas necessarias em componentes
- Build limpo: hub tsc --noEmit + vite build
- Proxima: F-005 hub-mutations-envelope

Session 5: Implementada F-005 hub-mutations-envelope.
- Refatoradas TODAS as 5 mutations em api/evolution.ts para retornar ApiResult<T>
- useCreateInstance: mutationFn retorna ApiResult<EvolutionInstance>
- useDeleteInstance: mutationFn retorna ApiResult<unknown>
- useReconnectInstance: mutationFn retorna ApiResult<unknown>
- useRestartInstance: mutationFn retorna ApiResult<unknown>
- useUpdateInstanceSettings: mutationFn retorna ApiResult<unknown>
- Query invalidation condicional: so invalida cache quando result.ok === true
- Atualizado create-instance-dialog.tsx: onSuccess verifica result.ok, toast amigavel via friendlyMessage()
- Atualizado whatsapp.tsx: handleDelete verifica result.ok, toast amigavel
- Atualizado whatsapp-instance.tsx: useActionState refatorado de ApiError(429/409) para ApiResult com cooldown_active/retries_exhausted
- Atualizado instance-settings-form.tsx: onSuccess verifica result.ok, toast amigavel
- Atualizado instance-table.tsx: handleReconnect e handleRestart verificam result.ok
- Build limpo: backbone tsc + hub tsc --noEmit + vite build
- Proxima: F-006 hub-create-dialog-separation

Session 6: Implementada F-006 hub-create-dialog-separation.
- Alterado navigate em create-instance-dialog.tsx: search.tab de "qr" para "status"
- Separacao de concerns: criacao de instancia nao assume linkagem imediata
- Comportamento de falha ja estava correto (dialog aberto, toast amigavel, form nao resetado) desde F-005
- Build limpo: hub tsc --noEmit + vite build
- Proxima: F-007 hub-whatsapp-page-no-error-state

Session 7: Implementada F-007 hub-whatsapp-page-no-error-state.
- Removido Card de erro com AlertTriangle de ambas as tabs (monitor e instances)
- isError nao controla mais a renderizacao — tabela sempre renderiza
- InstanceSummaryCards recebe instances diretamente (sem isError ? [] : instances)
- Removidos imports nao utilizados: AlertTriangle, Card, CardContent
- Removidos isError, error, refetch do useQuery destructuring
- Logica simplificada: isLoading ? loading : table (sem branch de erro)
- Build limpo: hub tsc --noEmit + vite build
- Proxima: F-008 hub-instance-page-no-error-card

Session 8: Implementada F-008 hub-instance-page-no-error-card.
- Removido componente InstanceErrorCard inteiro de whatsapp-instance.tsx
- Removido import de ApiError (nao mais necessario — backbone sempre retorna HTTP 200)
- Removido import de Card, CardContent (nao mais usados)
- evolutionInstanceQuery agora retorna ApiResult<EvolutionInstance> completo (nao unwrapped)
- Componente acessa result.ok e result.error para diferenciar cenarios inline
- Quando api_offline: mensagem inline com ServerOff icon e botao "Tentar novamente"
- Quando instance_not_found (ou qualquer outro erro): mensagem inline com AlertTriangle e link "Voltar para instancias"
- Tabs (status, qr, settings) sempre renderizam — erro so afeta conteudo da aba Status
- Atualizado instance-qr.tsx para consumir novo retorno (instanceResult?.ok ? instanceResult.data : null)
- useActionState inalterado — ja interpretava ApiResult desde F-005
- Build limpo: backbone tsc + hub tsc --noEmit + vite build
- Proxima: F-009 hub-qr-component-resilient

Session 9: Implementada F-009 hub-qr-component-resilient.
- evolutionInstanceQRQuery agora retorna ApiResult<EvolutionQR> completo (nao mais unwrapped)
- Erro de QR detectado via qrResult.ok === false (nao mais via isError do React Query)
- Estado "error" exibe friendlyMessage(qrError) inline com botao "Tentar novamente"
- Adicionada deteccao de instancia ja vinculada: se instance.state === "open" no mount, vai direto para "linked"
- Estado "linked" mostra "Instancia ja vinculada" com profileName/owner
- Estado "exhausted" substituido: "Recarregue a pagina" -> botao "Recomecar" com RotateCcw icon
- Estado "expired" com limite atingido: idem, botao "Recomecar" ao inves de texto de reload
- resetAttempts() zera attempts para 0 e volta para state "idle"
- Limite de 5 tentativas mantido
- Removido isError do React Query — erro vem exclusivamente do body
- Build limpo: backbone tsc + hub tsc --noEmit + vite build
- Proxima: F-010 hub-settings-form-resilient

Session 10: Implementada F-010 hub-settings-form-resilient.
- Adicionado guard `!settings` apos isLoading: quando query retorna null (ok: false), exibe "Configuracoes indisponiveis" inline com ServerOff icon e botao "Tentar novamente"
- Botao "Tentar novamente" invalida query cache via queryClient.invalidateQueries()
- Mutation onSuccess ja verificava result.ok e usava friendlyMessage() desde F-005 — nenhuma mudanca necessaria
- isError do React Query nao eh utilizado — so falha de rede real gera erro
- Form so renderiza quando settings != null (dados validos carregados)
- Consolidados imports de @tanstack/react-query (useQuery + useQueryClient)
- Build limpo: backbone tsc + hub tsc --noEmit + vite build
- Proxima: F-011 hub-delete-flow-resilient
