# Progress — 11-kai-needs-approval

## Current Status

F-001 a F-008 implementadas e passing. 8/10 features complete.

## Specs Path

D:\sources\codr.studio\cia-prime-care\agentic-backbone\apps\backbone\milestones\11-kai-needs-approval

## Environment

- **Stack:** Node.js, TypeScript (strict, ES2022, ESM), npm workspaces monorepo
- **Main package:** packages/kai-sdk (Vercel AI SDK v4, Zod)
- **Consumer:** apps/backbone (Hono, Claude Agent SDK)
- **Build:** `npm run build --workspace=packages/kai-sdk` / `npm run build --workspace=apps/backbone`
- **Dev:** `npm run dev:backbone` (tsx watch)
- **No test framework configurado** — validação via build + critérios manuais

## Features

- [x] F-001 types-tool-approval — Novos tipos em types.ts (ToolApprovalRequest, autoApprove, onToolApproval, evento tool_approval)
- [x] F-002 factory-bash-tool — Converter bashTool para factory createBashTool com needsApproval
- [x] F-003 factory-write-tool — Converter writeTool para factory createWriteTool com needsApproval
- [x] F-004 factory-edit-tool — Converter editTool para factory createEditTool com needsApproval
- [x] F-005 factory-multi-edit-tool — Converter multiEditTool para factory createMultiEditTool com needsApproval
- [x] F-006 factory-apply-patch-tool — Converter applyPatchTool para factory createApplyPatchTool com needsApproval
- [x] F-007 agent-tools-assembly — Integrar factories no agent.ts e exportar em tools/index.ts
- [x] F-008 tool-approval-event-emission — Emissão do evento tool_approval com callback onToolApproval
- [ ] F-009 exports-and-backward-compat — Exports finais em index.ts + validação de backward compat
- [ ] F-010 build-verification — Build final de verificação (kai-sdk + backbone)

## Architecture Decisions

1. **autoApprove default true** — Backward compat: consumidores existentes (heartbeat, testes) não precisam mudar nada
2. **Factory pattern** — Tools sensíveis (Bash, Write, Edit, MultiEdit, ApplyPatch) passam de constantes para factories que recebem `{ autoApprove }`. Constante original mantida como `createXTool()` para backward compat
3. **needsApproval do Vercel AI SDK** — Quando `autoApprove === false`, a tool declara `needsApproval: async () => true`. O SDK pausa a execução e o consumidor decide via callback
4. **Dois modos de uso** — Heartbeat (autônomo, `autoApprove: true`) vs Conversa (interativo, `autoApprove: false` + `onToolApproval`)
5. **Sem novas dependências** — Apenas reorganização de código existente + uso de API do Vercel AI SDK v4
6. **Tools de leitura nunca pedem aprovação** — Read, Glob, Grep, ListDir, WebFetch, TodoWrite/Read, Diagnostics ficam inalteradas
7. **Execute wrapping ao invés de needsApproval nativo** — ai@4.3.19 não suporta needsApproval no `tool()`. A interceptação é feita via wrapping do execute function dos dangerous tools no agent.ts, com dreno de eventos via pendingStepEvents

## Session Notes

Session 1 (Initializer): Harness criado para onda agenticbackbone-11-kai-needs-approval--cc com 10 features (todas failing).
Session 2 (CC): Implementada F-001 types-tool-approval — adicionados ToolApprovalRequest, autoApprove, onToolApproval em KaiAgentOptions, e evento tool_approval em KaiAgentEvent. Build passing. Next: F-002 factory-bash-tool.
Session 3 (CC): Implementada F-002 factory-bash-tool — bashTool convertida para factory createBashTool(opts?) com needsApproval condicional via Object.assign. Backward compat mantida com export const bashTool = createBashTool(). ai@4.3.19 não suporta needsApproval nativamente, então é adicionado como propriedade custom no objeto retornado. Build passing. Next: F-003 factory-write-tool.
Session 4 (CC): Implementada F-003 factory-write-tool — writeTool convertida para factory createWriteTool(opts?) seguindo o mesmo pattern de F-002 (Object.assign com needsApproval condicional). Backward compat mantida com export const writeTool = createWriteTool(). Lógica interna (mkdir, writeFile) inalterada. Build passing. Next: F-004 factory-edit-tool.
Session 5 (CC): Implementada F-004 factory-edit-tool — editTool convertida para factory createEditTool(opts?) seguindo o mesmo pattern de F-002/F-003 (Object.assign com needsApproval condicional). Backward compat mantida com export const editTool = createEditTool(). Lógica interna (readFile, replace, writeFile) inalterada. kai-sdk build passing. Next: F-005 factory-multi-edit-tool.
Session 6 (CC): Implementada F-005 factory-multi-edit-tool — multiEditTool convertida para factory createMultiEditTool(opts?) seguindo o mesmo pattern (Object.assign com needsApproval condicional). Backward compat mantida com export const multiEditTool = createMultiEditTool(). Lógica interna (validação atômica, replace sequencial, writeFile) inalterada. kai-sdk build passing. Next: F-006 factory-apply-patch-tool.
Session 7 (CC): Implementada F-006 factory-apply-patch-tool — applyPatchTool convertida para factory createApplyPatchTool(opts?) seguindo o mesmo pattern (Object.assign com needsApproval condicional). Backward compat mantida com export const applyPatchTool = createApplyPatchTool(). Lógica interna (parsePatch, applyUpdate, execute) inalterada. kai-sdk build passing. Next: F-007 agent-tools-assembly.
Session 8 (CC): Implementada F-007 agent-tools-assembly — agent.ts agora lê options.autoApprove (default true) e monta dangerousTools com as 5 factories (createBashTool, createWriteTool, createEditTool, createMultiEditTool, createApplyPatchTool). dangerousTools sobrescreve codingTools no spread, garantindo que autoApprove é respeitado. tools/index.ts agora exporta as 5 factory functions. codingTools continua usando as constantes para backward compat. kai-sdk build passing. Next: F-008 tool-approval-event-emission.
Session 9 (CC): Implementada F-008 tool-approval-event-emission — Quando autoApprove é false, agent.ts agora wrapa o execute de cada dangerous tool (Bash, Write, Edit, MultiEdit, ApplyPatch) para interceptar chamadas antes da execução. O wrapper invoca onToolApproval callback (ou auto-aprova com console.warn se callback ausente), emite evento tool_approval via pendingStepEvents, e rejeita a execução se não aprovado. ai@4.3.19 não tem needsApproval nativo, então a interceptação é feita via wrapping do execute no layer do agent. Eventos são drenados no fullStream em tool-result e step-finish. kai-sdk build passing. Next: F-009 exports-and-backward-compat.
