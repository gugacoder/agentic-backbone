# Agent Harness Progress — agenticbackbone-02-kai-brain--cc

## Current Status
F-007 PASSING — 3 system prompt modes integrated in runKaiAgent()

## Specs Path
D:\sources\codr.studio\cia-prime-care\agentic-backbone\packages\kai-sdk\milestones\02-kai-brain

## Environment
- Stack: Node.js, TypeScript (ES2022, ESM), npm workspaces monorepo
- Package: @agentic-backbone/kai-sdk (packages/kai-sdk)
- Build: npm run build --workspace=packages/kai-sdk (tsc)
- Dev: npm run dev (tsc --watch) no workspace kai-sdk
- No test framework configured — validation via build + manual criteria

## Features

[x] F-001 prompt-modules-md — Criados identity.md (77t), tool-guide.md (152t), patterns.md (128t), safety.md (90t)
[x] F-002 tool-specific-prompts — Criados read.md(57t), write.md(59t), edit.md(67t), bash.md(65t), glob.md(65t), grep.md(58t)
[x] F-003 assembler-getSystemPrompt — assembly.ts com getSystemPrompt(activeTools), 811 tokens com 6 tools
[x] F-004 discover-project-context — discoverProjectContext(cwd) walk-up ate .git, coleta AGENTS.md/CLAUDE.md, trunca >4000t
[x] F-005 system-option-types — system: string | { append } | undefined, cwd?: string adicionado
[x] F-006 export-public-api — getSystemPrompt e discoverProjectContext exportados via index.ts
[x] F-007 agent-integration-3-modes — 3 modos integrados: undefined(auto), {append}(base+ctx+extra), string(override)
[ ] F-008 build-validation — Validacao final: build, exports, token budget

## Architecture Decisions

1. **Modular markdown prompts** — Cada modulo (.md) e independente e autonomo. Sem dependencias cruzadas.
2. **Build-time embedding** — Os .md sao embutidos como strings no bundle (nao lidos do filesystem em runtime). Isso garante que o SDK funciona como pacote npm.
3. **Tool-filtered assembly** — getSystemPrompt recebe activeTools[] e inclui apenas os tools/*.md correspondentes.
4. **3 modos de system prompt** — omitido (auto), { append } (adiciona ao base), string (override total). Segue padrao Claude Agent SDK.
5. **Walk-up context discovery** — discoverProjectContext sobe do cwd ate .git/raiz, coletando AGENTS.md e CLAUDE.md. Executado uma vez no inicio.
6. **Token budgets** — Base: max 2000 tokens. Contexto projeto: max 4000 tokens. Total: max 6000 tokens.

## Session Notes

### Session 2026-02-16T21:30
- Implemented F-001: Created 4 markdown modules in src/prompts/
- Token counts verified: identity(77), tool-guide(152), patterns(128), safety(90) — all within limits
- No cross-references between modules
- Build passes clean
- Next priority: F-002 (tool-specific-prompts)

### Session 2026-02-16T22:15
- Implemented F-002: Created 6 tool-specific markdown files in src/prompts/tools/
- All files follow standard format: ## Header, **Use para:**, **NAO use para:**, **Dica:**
- Token counts verified: read(57), write(59), edit(67), bash(65), glob(65), grep(58) — all within 100t limit
- No cross-references between modules
- Build passes clean
- F-003 (assembler-getSystemPrompt) unblocked — dependencies F-001 + F-002 now passing
- Next priority: F-003 (assembler-getSystemPrompt)

### Session 2026-02-16T23:00
- Implemented F-003: Created src/prompts/assembly.ts with getSystemPrompt(activeTools)
- All .md content embedded as string constants (no fs reads at runtime)
- TOOL_PROMPTS record maps tool names to their prompt strings
- Assembly order verified: identity → tool-guide → tools (filtered) → patterns → safety
- Unknown tools in activeTools silently ignored
- Token counts (tiktoken gpt-4o): base(443), 2-tools(563), 6-tools(811) — well within 2000t budget
- Separator: double newline between modules, no XML tags
- Build passes clean
- F-006 (export-public-api) now unblocked — F-003 dependency satisfied
- Next priority: F-004 (discover-project-context)

### Session 2026-02-16T23:45
- Implemented F-004: Created discoverProjectContext(cwd) in src/prompts/assembly.ts
- Walks up directory tree from cwd to .git root or filesystem root
- Collects AGENTS.md and CLAUDE.md in each directory (AGENTS.md first per PRP)
- Per-directory group collection ensures correct ordering after reversal (root → cwd)
- Empty files (whitespace-only) are skipped
- Token budget: 4000 tokens max, truncates most distant files first
- Uses existing countTokens() from context/tokenizer.ts (js-tiktoken gpt-4o)
- All 11 acceptance criteria verified via manual tests
- Build passes clean
- F-006 (export-public-api) now unblocked — both F-003 + F-004 dependencies passing
- Next priority: F-005 (system-option-types)

### Session 2026-02-17T00:10
- Completed F-005: Updated KaiAgentOptions in types.ts
  - system field: string | { append: string } | undefined (3 modes per PRP)
  - Added cwd?: string for project context discovery directory
  - Fixed agent.ts type narrowing: `typeof options.system === "string"` guard for streamText compatibility
  - Types already exported via index.ts (KaiAgentOptions re-export)
- Completed F-006: Added public API exports in src/index.ts
  - getSystemPrompt exported from ./prompts/assembly.js
  - discoverProjectContext exported from ./prompts/assembly.js
  - Verified exports resolvable via node require() on dist/
- Build passes clean
- F-007 (agent-integration-3-modes) now unblocked — all dependencies F-003, F-004, F-005, F-006 passing
- Next priority: F-007 (agent-integration-3-modes)

### Session 2026-02-17T01:00
- Implemented F-007: Modified runKaiAgent() in agent.ts to integrate 3 system prompt modes
  - Mode 1 (undefined): builds base prompt via getSystemPrompt(Object.keys(tools)) + discoverProjectContext(cwd)
  - Mode 2 ({ append }): base + project context + consumer's append string
  - Mode 3 (string): full override — only the consumer's string, no base, no discovery
  - activeTools extracted from Object.keys(tools) after full tool resolution (includes MCP, coding, AskUser, Task, Batch)
  - discoverProjectContext called once before streamText (not per step)
  - cwd defaults to process.cwd() when not provided in options
  - systemPrompt always passed to streamText (no more conditional spread)
- All 7 acceptance criteria verified via node validation scripts
- Build passes clean
- F-008 (build-validation) now unblocked — F-007 dependency satisfied
- Next priority: F-008 (build-validation)
