[
  {
    "id": "F-001",
    "name": "loop-control-types",
    "description": "Adicionar os novos tipos PrepareStepContext, PrepareStepResult e o novo evento step_finish em types.ts. Adicionar campos stopWhen e prepareStep em KaiAgentOptions.",
    "status": "passing",
    "completed_at": "2026-02-17",
    "priority": 1,
    "tests": [
      "types.ts exporta PrepareStepContext com campos: stepNumber (number), stepCount (number), previousToolCalls (string[])",
      "types.ts exporta PrepareStepResult com campos opcionais: model (string), activeTools (string[]), toolChoice (union type)",
      "KaiAgentOptions possui campo opcional stopWhen do tipo (event: StepFinishEvent) => boolean",
      "KaiAgentOptions possui campo opcional prepareStep do tipo (context: PrepareStepContext) => PrepareStepResult | undefined",
      "KaiAgentEvent inclui variante { type: 'step_finish'; step: number; toolCalls: string[]; finishReason: string }",
      "npm run build --workspace=packages/kai-sdk compila sem erros de tipo"
    ],
    "dependencies": [],
    "prp_path": "D:\\sources\\codr.studio\\cia-prime-care\\agentic-backbone\\apps\\backbone\\milestones\\07-kai-loop-control\\PRP.md"
  },
  {
    "id": "F-002",
    "name": "step-finish-events",
    "description": "Implementar emissao de eventos step_finish via onStepFinish no streamText. O onStepFinish popula um array de eventos que sao emitidos durante o loop de streaming, entre os text-deltas.",
    "status": "passing",
    "completed_at": "2026-02-17",
    "priority": 2,
    "tests": [
      "onStepFinish no streamText registra step number, tool calls e finish reason",
      "Eventos step_finish sao emitidos no async generator entre text-deltas",
      "Quando nao ha tool calls no step, toolCalls eh array vazio",
      "runKaiAgent() sem prepareStep/stopWhen emite step_finish normalmente",
      "npm run build --workspace=packages/kai-sdk compila sem erros"
    ],
    "dependencies": [
      "F-001"
    ],
    "prp_path": "D:\\sources\\codr.studio\\cia-prime-care\\agentic-backbone\\apps\\backbone\\milestones\\07-kai-loop-control\\PRP.md"
  },
  {
    "id": "F-003",
    "name": "prepare-step-integration",
    "description": "Integrar o callback prepareStep no streamText. Quando options.prepareStep eh fornecido, mapear para o prepareStep do Vercel AI SDK, traduzindo model (via openrouter()), activeTools e toolChoice.",
    "status": "passing",
    "completed_at": "2026-02-17",
    "priority": 3,
    "tests": [
      "Quando prepareStep NAO eh fornecido, streamText eh chamado sem prepareStep (comportamento identico ao antes)",
      "Quando prepareStep retorna { model: 'outro-modelo' }, o step usa openrouter('outro-modelo')",
      "Quando prepareStep retorna { activeTools: ['Read', 'Grep'] }, apenas essas tools ficam disponiveis no step",
      "Quando prepareStep retorna { toolChoice: 'required' }, o toolChoice eh passado ao Vercel AI SDK",
      "Quando prepareStep retorna undefined, nenhum override eh aplicado ao step",
      "previousToolCalls no contexto contem os nomes das tools chamadas no step anterior",
      "npm run build --workspace=packages/kai-sdk compila sem erros"
    ],
    "dependencies": [
      "F-001"
    ],
    "prp_path": "D:\\sources\\codr.studio\\cia-prime-care\\agentic-backbone\\apps\\backbone\\milestones\\07-kai-loop-control\\PRP.md"
  },
  {
    "id": "F-004",
    "name": "stop-when-integration",
    "description": "Implementar stopWhen como condicao de parada customizada. Usar onStepFinish para avaliar a condicao e abortar o stream quando retornar true. Manter maxSteps como limite superior.",
    "status": "failing",
    "priority": 4,
    "tests": [
      "Quando stopWhen NAO eh fornecido, loop usa apenas maxSteps como limite (comportamento identico ao antes)",
      "Quando stopWhen retorna true, o loop eh interrompido antes de atingir maxSteps",
      "Quando stopWhen retorna false, o loop continua normalmente ate maxSteps",
      "stopWhen recebe o evento step_finish com step number, toolCalls e finishReason",
      "maxSteps continua funcionando como limite superior mesmo com stopWhen",
      "npm run build --workspace=packages/kai-sdk compila sem erros"
    ],
    "dependencies": [
      "F-002"
    ],
    "prp_path": "D:\\sources\\codr.studio\\cia-prime-care\\agentic-backbone\\apps\\backbone\\milestones\\07-kai-loop-control\\PRP.md"
  },
  {
    "id": "F-005",
    "name": "public-exports",
    "description": "Atualizar index.ts para exportar os novos tipos: PrepareStepContext, PrepareStepResult, e o tipo do evento step_finish (ja incluido em KaiAgentEvent).",
    "status": "failing",
    "priority": 5,
    "tests": [
      "index.ts exporta PrepareStepContext",
      "index.ts exporta PrepareStepResult",
      "Todos os tipos previamente exportados continuam exportados (sem regressao)",
      "npm run build --workspace=packages/kai-sdk compila sem erros"
    ],
    "dependencies": [
      "F-001"
    ],
    "prp_path": "D:\\sources\\codr.studio\\cia-prime-care\\agentic-backbone\\apps\\backbone\\milestones\\07-kai-loop-control\\PRP.md"
  },
  {
    "id": "F-006",
    "name": "build-verification",
    "description": "Verificacao final: build limpo do kai-sdk e validacao de que o comportamento default (sem prepareStep/stopWhen) nao foi alterado.",
    "status": "blocked",
    "priority": 6,
    "tests": [
      "npm run build --workspace=packages/kai-sdk compila sem erros nem warnings",
      "Declaracao de streamText sem prepareStep/stopWhen eh identica a versao anterior (mesmos parametros, mesma ordem)",
      "Nenhuma dependencia nova foi adicionada ao package.json",
      "Nenhum arquivo fora de packages/kai-sdk/src/ foi modificado (types.ts, agent.ts, index.ts apenas)"
    ],
    "dependencies": [
      "F-001",
      "F-002",
      "F-003",
      "F-004",
      "F-005"
    ],
    "prp_path": "D:\\sources\\codr.studio\\cia-prime-care\\agentic-backbone\\apps\\backbone\\milestones\\07-kai-loop-control\\PRP.md"
  }
]
