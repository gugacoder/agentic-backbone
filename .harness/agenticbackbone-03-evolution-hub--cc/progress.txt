# Progress — agenticbackbone-03-evolution-hub--cc

## Current Status
17/23 features complete. PRP 01 (Module System) completo. PRP 02 (Evolution Module) completo. PRP 03 em andamento: F-013 a F-017 passing. Hub + backbone builds passam sem erros.

## Specs Path
D:\sources\codr.studio\cia-prime-care\agentic-backbone\apps\backbone\milestones\03-evolution-hub

### PRPs Cobertos
- PRP 01: apps/backbone/milestones/01-module-system/PRP.md (Module System — infraestrutura)
- PRP 02: apps/backbone/milestones/02-evolution-module/PRP.md (Evolution Module — backend)
- PRP 03: apps/backbone/milestones/03-evolution-hub/PRP.md (Evolution Hub — frontend)

## Environment

### Stack
- Backend: Node.js + Hono + TypeScript (ESM, ES2022)
- Frontend: React 19 + Vite 6 + TanStack Router v1 + TanStack React Query v5
- UI: shadcn + Radix + Tailwind v4 + lucide-react + sonner + framer-motion
- Forms: react-hook-form + @hookform/resolvers + zod
- State: Zustand v5 (auth, UI)
- Real-time: SSE via useSSE() hook
- DB: SQLite (WAL mode) + sqlite-vec

### Commands
- Dev backbone: npm run dev:backbone
- Dev hub: npm run dev:hub
- Dev all: npm run dev:all
- Build backbone: npm run build --workspace=apps/backbone
- Build hub: npm run build --workspace=apps/hub
- Platform (Docker): npm run platform:up / platform:down

### Key Patterns
- Async generator streaming (AgentEvent)
- Prompt assembly via XML sections
- File-based context repository (context/)
- Module isolation via ModuleContext
- Event-driven (EventEmitter + SSE)
- URL = single source of truth for UI state
- shadcn + CSS tokens (no Tailwind colors in code)
- Interface em pt-BR

## Features

### PRP 01 — Module System (F-001 to F-004)
- [x] F-001 — Module system types (types.ts: BackboneModule, ModuleContext, ModuleHealth)
- [x] F-002 — Module loader (loader.ts: startModules, stopModules, getModuleHealth)
- [x] F-003 — Module registry + event bus extensions (index.ts + emitModule/onModule/offModule)
- [x] F-004 — Module lifecycle integration (index.ts startup/shutdown + /health modules section)

### PRP 02 — Evolution Module (F-005 to F-012)
- [x] F-005 — Evolution types and config (types.ts + config.ts + CONFIG.yaml)
- [x] F-006 — Evolution probe (probe.ts: autonomous health check loop)
- [x] F-007 — Instance state tracking (state.ts: per-instance state with temporal history)
- [x] F-008 — Pattern detection (patterns.ts: flapping + prolonged offline)
- [x] F-009 — Corrective actions (actions.ts: reconnect/restart with retry policy)
- [x] F-010 — HTTP routes monitoring (routes.ts: health, instances, reconnect, restart)
- [x] F-011 — Module entry point + registration (evolution/index.ts + modules/index.ts)
- [x] F-012 — CRUD and QR backend routes (create, delete, qr, settings — proxy to Evolution API)

### PRP 03 — Evolution Hub (F-013 to F-023)
- [x] F-013 — Hub API layer (src/api/evolution.ts: queries + mutations + types)
- [x] F-014 — Sidebar and routing (Conectividade section + /conectividade routes + search params)
- [x] F-015 — Connectivity index page (/conectividade: grid of connectivity cards)
- [x] F-016 — Health and summary cards (api-health-card + instance-summary-cards)
- [x] F-017 — Instance table and dashboard tabs (Monitor + Instances tabs, criticality sort, alert indicators)
- [ ] F-018 — Create instance dialog + delete confirmation
- [ ] F-019 — Instance detail status tab (state card, corrective actions, event feed)
- [ ] F-020 — Instance detail QR code tab (QR flow with countdown + poll)
- [ ] F-021 — Instance detail settings tab (form with switches)
- [ ] F-022 — SSE integration for Evolution events (query invalidation + toasts)
- [ ] F-023 — Responsiveness and polish (mobile/desktop layouts)

## Architecture Decisions

### From PRP 01 (Module System)
- Modules registered explicitly in array (no filesystem discovery)
- Module failure does NOT crash backbone (graceful degradation)
- Module events use namespace module:{name}:{event} via emitModule()
- Module routes mounted at /api/modules/{name}/ behind JWT middleware
- ModuleContext is the only interface between backbone and modules

### From PRP 02 (Evolution Module)
- Probe uses same endpoint that returns instances (no separate /health)
- State tracking in memory (Map), rebuilt on boot from first probe
- Module does NOT auto-execute corrective actions (operator/agent decides)
- Config from CONFIG.yaml in context dir (not hardcoded)
- Conditional registration: only if EVOLUTION_API_URL is defined

### From PRP 03 (Evolution Hub)
- Hub NEVER calls Evolution API directly — all via backbone module
- Section named "Conectividade" (extensible), item named "WhatsApp" (user-facing)
- Event feed is client-side only (resets on page reload)
- QR code displayed as base64 image from Evolution API
- All navigation bookmarkable (search params for tabs/views)
- SSE toasts fire regardless of active page (layout-level listener)

## Session Notes
- Session 1 (Initializer): Harness criado para onda agenticbackbone-03-evolution-hub--cc
  - 23 features decompostas de 3 PRPs
  - Dependencia clara: PRP 01 -> PRP 02 -> PRP 03
  - Backend (F-001 a F-012) deve ser implementado antes do frontend (F-013 a F-023)
  - Nenhum modulo ou Evolution code existe no projeto ainda — tudo a ser criado

- Session 2: Implementou F-001 — Module system types
  - Criou src/modules/types.ts com BackboneModule, ModuleContext, ModuleHealth
  - Exportou BackboneEventBus class em events/index.ts (era privada, necessario para tipagem de ModuleContext)
  - Build passa sem erros
  - Proxima prioridade: F-002 (Module loader) ou F-003 (Module registry + event bus extensions)

- Session 3: Implementou F-002 — Module loader
  - Criou src/modules/loader.ts com startModules(), stopModules(), getModuleHealth()
  - startModules() recebe array de BackboneModule[] e Hono app
  - Cria ModuleContext para cada modulo (eventBus, dbPath, contextDir, log, env)
  - Garante contextDir existe (mkdirSync recursive)
  - Se start() falha, marca unhealthy e continua
  - Monta routes em /modules/{name}/ se modulo tem routes
  - stopModules() chama stop() em ordem inversa
  - getModuleHealth() retorna Record<string, ModuleHealth>
  - Build passa sem erros
  - Proxima prioridade: F-003 (Module registry + event bus extensions)

- Session 4: Implementou F-003 — Module registry + event bus extensions
  - Criou src/modules/index.ts com array de BackboneModule[] (inicialmente vazio)
  - Adicionou emitModule(), onModule(), offModule() ao BackboneEventBus em events/index.ts
  - Adicionou onAnyModuleEvent() para SSE hub consumir eventos de modulo dinamicos
  - SSE hub (events/sse.ts) agora propaga eventos module:* automaticamente para clientes
  - Eventos de modulo armazenados em lastEvents e disponiveis via getLastModuleEvent()
  - Build passa sem erros
  - Proxima prioridade: F-004 (Module lifecycle integration)

- Session 5: Implementou F-004 — Module lifecycle integration
  - Importou modules array e startModules/stopModules em src/index.ts
  - startModules(modules, app) chamado apos wireEventBusToHooks() na sequencia de startup
  - stopModules() chamado no handler onShutdown() antes de shutdownAllJobs()
  - onShutdown() agora e async para awaitar stopModules()
  - /health endpoint inclui campo modules: getModuleHealth() em routes/index.ts
  - Backbone sobe normalmente com array vazio (0 modulos)
  - PRP 01 (Module System) totalmente implementado (F-001 a F-004)
  - Build passa sem erros
  - Proxima prioridade: F-005 (Evolution types and config) — inicio do PRP 02

- Session 6 (uncommitted): F-005 types.ts e config.ts ja existiam no working tree (criados em sessao anterior nao commitada)
  - Verificou que CONFIG.yaml ainda nao existia; criou em context/modules/evolution/
  - Build passava sem erros

- Session 7: Implementou F-006 — Evolution probe
  - Criou src/modules/evolution/probe.ts com classe EvolutionProbe
  - Loop autonomo: start() executa tick() imediatamente + setInterval(intervalMs)
  - Maquina de estados: unknown -> online/offline com emissao de eventos corretos
  - Timeout via AbortController com config.probe.timeoutMs
  - Callback onInstances para passar dados de instancias para state tracker
  - Transicao unknown->online silenciosa, unknown->offline e online->offline emitem api-offline
  - offline->online emite api-online
  - Fetch errors capturados graciosamente (nao quebra no boot)
  - Build passa sem erros
  - Proxima prioridade: F-007 (Instance state tracking)

- Session 8: Implementou F-007 — Instance state tracking
  - Criou src/modules/evolution/state.ts com classe EvolutionStateTracker
  - Map em memoria rastreia estado por instancia (instanceName, instanceId, state, since, previousState, owner)
  - update() recebe raw instances do probe e detecta: novas (instance-discovered), removidas (instance-removed), transicoes de estado
  - Transicoes: open->close emite instance-disconnected, open->connecting emite instance-reconnecting
  - close->open e connecting->open emitem instance-connected, connecting->close emite instance-disconnected
  - Payload de todos os eventos inclui ts, instanceName, state, previousState, since, durationInPreviousState
  - getInstances() retorna lista com durationMs calculado (now - since)
  - getInstance(name) retorna instancia individual com duracao
  - normalizeState() mapeia status da Evolution API para tipos esperados
  - Build passa sem erros
  - Proxima prioridade: F-008 (Pattern detection) ou F-009 (Corrective actions)

- Session 9: Implementou F-008 — Pattern detection
  - Criou src/modules/evolution/patterns.ts com classe EvolutionPatternDetector
  - Flapping: recordStateChange() mantem array de timestamps por instancia, prune fora da janela
  - Quando changeCount >= thresholds.flapping.changes na janela, emite instance-unstable
  - Prolonged offline: checkProlongedOffline() verifica instancias em state "close" com durationMs > threshold
  - Deduplicacao por ocorrencia via Set com chave instanceName:since
  - Se instancia volta e cai novamente, since muda e nova ocorrencia pode ser emitida
  - Cleanup automatico de entradas stale quando instancia sai de "close"
  - clearInstance() para limpeza ao remover instancias
  - Build passa sem erros
  - Proxima prioridade: F-009 (Corrective actions)

- Session 10: Implementou F-009 — Corrective actions
  - Criou src/modules/evolution/actions.ts com classe EvolutionActions
  - reconnect() chama GET /instance/connect/{name} na Evolution API
  - restart() chama PUT /instance/restart/{name} na Evolution API
  - Retry policy: cooldownMs entre tentativas (rejeita com cooldown_active + retryAfterMs)
  - Max retries: rejeita com retries_exhausted apos maxRetries tentativas
  - Sucesso emite action-success, falha emite action-failed
  - Quando maxRetries atingido emite action-exhausted
  - resetCounters(instanceName) zera contadores quando instancia volta para open
  - removeInstance(instanceName) limpa estado ao remover instancia
  - State tracking per-instance per-action via Map com chave instanceName:action
  - Build passa sem erros
  - Proxima prioridade: F-010 (HTTP routes monitoring)

- Session 11: Implementou F-010 — Evolution HTTP routes (monitoring)
  - Corrigiu bug pre-existente: maxTurns faltando em AgentProviderOptions (src/agent/providers/types.ts)
  - Criou src/modules/evolution/routes.ts com factory function createEvolutionRoutes(deps)
  - GET /health retorna apiState + lastProbe (timestamp, status, responseTimeMs, error)
  - GET /instances retorna lista de instancias com estado, since, previousState, durationMs (503 se API offline)
  - GET /instances/:name retorna detalhe de uma instancia (404 se nao encontrada)
  - POST /instances/:name/reconnect executa reconnect via EvolutionActions (retry policy)
  - POST /instances/:name/restart executa restart via EvolutionActions (retry policy)
  - Erros tipados: 429 cooldown_active, 409 retries_exhausted, 503 api_offline, 404 instance_not_found
  - Helper actionResultToResponse() mapeia ActionResult para HTTP status codes
  - Deps injetadas via RouteDeps interface (probe, state, actions) — wiring acontece no F-011
  - Build passa sem erros
  - Proxima prioridade: F-011 (Module entry point + registration)

- Session 12: Implementou F-011 — Evolution module entry point and registration
  - Criou src/modules/evolution/index.ts com evolutionModule implementando BackboneModule
  - start(ctx): carrega config, inicializa probe, stateTracker, patternDetector, actions
  - Wiring: probe.onInstances -> stateTracker.update() -> patternDetector.checkProlongedOffline()
  - Event listeners: instance-connected reseta contadores + registra mudanca no pattern detector
  - Event listeners: instance-disconnected/reconnecting registra mudancas para flapping detection
  - Event listeners: instance-removed limpa estado em patterns e actions
  - routes criado via createEvolutionRoutes() e atribuido a this.routes dentro de start()
  - stop(): para probe, limpa todas as referencias
  - health(): retorna unhealthy se API offline, degraded se unknown ou instancias offline, healthy caso contrario
  - Atualizado src/modules/index.ts com registro condicional: so inclui evolutionModule se EVOLUTION_API_URL definida
  - Corrigiu tipo dos event listeners (payload unknown -> cast via helper)
  - PRP 02 (Evolution Module): 7/8 features completas (falta F-012 CRUD/QR)
  - Build passa sem erros
  - Proxima prioridade: F-012 (CRUD and QR backend routes)

- Session 13: Implementou F-012 — Evolution CRUD and QR backend routes
  - Corrigiu build error pre-existente: env faltando em createEvolutionRoutes() call em index.ts
  - Rotas CRUD ja existiam em routes.ts (criadas em sessao anterior nao commitada)
  - POST /instances cria instancia via Evolution API (POST {baseUrl}/instance/create)
  - DELETE /instances/:name remove instancia (DELETE {baseUrl}/instance/delete/{name})
  - GET /instances/:name/qr retorna QR code (GET {baseUrl}/instance/connect/{name})
  - GET /instances/:name/settings retorna configuracoes (GET {baseUrl}/settings/find/{name})
  - PATCH /instances/:name/settings atualiza configuracoes (POST {baseUrl}/settings/set/{name})
  - Adicionou forceTick() ao EvolutionProbe para invalidacao imediata do cache de estado
  - Create e delete chamam forceTick() apos sucesso para atualizar state tracker imediatamente
  - Todas as rotas proxy verificam apiState e retornam 503 se API offline
  - Erros de proxy retornam 502 com detalhes
  - PRP 02 (Evolution Module) completo: 8/8 features (F-005 a F-012)
  - Build passa sem erros
  - Proxima prioridade: F-013 (Hub API layer for Evolution) — inicio do PRP 03

- Session 14: Implementou F-013, F-014, F-015 — Hub API layer, sidebar/routing, connectivity index
  - F-013: API layer (evolution.ts) ja existia de sessao anterior nao commitada com todos queries/mutations/types
  - F-014: Registrou 3 rotas no App.tsx (/conectividade, /conectividade/whatsapp, /conectividade/whatsapp/$name)
  - F-014: Adicionou secao "Conectividade" com icone Cable no sidebar (entre Resources e Admin)
  - F-014: Item "WhatsApp" com icone MessageCircle linkando para /conectividade/whatsapp
  - F-014: Search params validados: view (monitor|instances) para whatsapp, tab (status|qr|settings) para instancia
  - F-014: Rotas protegidas por auth via protectedLayoutRoute (beforeLoad auth guard)
  - F-015: connectivity.tsx ja existia com PageHeader, card WhatsApp, contagem online/offline, grid responsivo, pt-BR
  - Corrigiu build do hub que falhava por paginas/componentes de sessoes anteriores referenciando rotas nao registradas
  - Build de backbone e hub passam sem erros
  - PRP 03 em andamento: 3/11 features completas (F-013, F-014, F-015)
  - Proxima prioridade: F-016 (Health and summary cards)

- Session 15: Corrigiu tipos F-013 — Hub API types alinhados com backend
  - EvolutionHealth: renomeou status (healthy/degraded/unhealthy) para apiState (online/offline/unknown) conforme backend /modules/evolution/health
  - EvolutionHealth: lastProbe agora e objeto EvolutionProbeResult (timestamp, status, responseTimeMs, error), nao string
  - EvolutionInstance: since agora e number (timestamp ms), nao string
  - EvolutionInstance: adicionou instanceId, durationMs, profileName (string | null)
  - EvolutionInstance: owner agora e string | null (nao optional string)
  - Adicionou profileName a InstanceState no backend (types.ts + state.ts) — dado ja existia no RawInstance mas nao era persistido
  - Corrigiu api-health-card.tsx: usa apiState e lastProbe.responseTimeMs/timestamp conforme novo tipo
  - Corrigiu connectivity.tsx: usa evolutionInstancesQuery (nao mais health.instances que nao existia no backend)
  - Corrigiu instance-status-card.tsx: timeAgo e formatDate aceitam number, removido previousStateDuration inexistente
  - Corrigiu instance-table.tsx: timeAgo aceita number, sortByCriticality usa since direto (ja e number)
  - Backbone build e hub build passam sem erros
  - Proxima prioridade: F-016 (Health and summary cards)

- Session 16: Implementou F-016 — Health and summary cards
  - api-health-card.tsx ja existia de sessao anterior com status badge (online=verde, unknown=amarelo, offline=vermelho), response time, ultimo probe relativo
  - instance-summary-cards.tsx ja existia; adicionou cores de fundo semanticas nos cards (bg-chart-2/10 para Online, bg-chart-4/10 para Conectando, bg-destructive/10 para Offline)
  - Adicionou border colors semanticos (border-chart-2/20, border-chart-4/20, border-destructive/20)
  - Numeros dos cards agora usam cor semantica (text-chart-2, text-chart-4, text-destructive)
  - Ativou useEvolutionSSE() no WhatsAppPage para invalidacao de queries via SSE (api-online/api-offline invalidam health query)
  - Grid 3 colunas desktop, stack mobile ja estava implementado (grid-cols-1 sm:grid-cols-3)
  - Hub + backbone builds passam sem erros
  - Proxima prioridade: F-017 (Instance table and dashboard tabs)

- Session 17: Implementou F-017 — Instance table and dashboard tabs
  - whatsapp.tsx ja tinha estrutura completa: PageHeader, Tabs (Monitor/Instancias), CreateInstanceDialog, ConfirmDialog
  - instance-table.tsx ja tinha ambos variants (monitor com botoes inline, instances com dropdown menu)
  - Adicionou InstanceAlerts interface e tracking no useEvolutionSSE (unstable + prolongedOffline Sets)
  - SSE events instance-unstable e instance-prolonged-offline adicionam ao alert set
  - SSE events instance-connected e instance-removed limpam alerts
  - useEvolutionSSE agora retorna { alerts } consumido por WhatsAppPage
  - instance-table.tsx recebe alerts? prop e exibe:
    - AlertTriangle + tooltip "Conexao instavel" para instancias com unstable alert
    - Badge "Offline prolongado" ao lado da duracao para instancias com prolonged-offline alert
  - Tabela monitor: criticality sort (close > connecting > open), duracao atualizada a cada 10s, botoes disabled para online
  - Tabela instances: Nome (link), Numero, Estado, Perfil, dropdown (detalhes/reconectar/reiniciar/excluir)
  - Responsivo: Numero hidden em mobile (sm:), Perfil hidden em mobile/tablet (md:)
  - Hub + backbone builds passam sem erros
  - Proxima prioridade: F-018 (Create instance dialog + delete confirmation)
