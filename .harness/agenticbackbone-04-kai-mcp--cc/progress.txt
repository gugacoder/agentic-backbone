# Progress — 04-kai-mcp

## Current Status
ALL 8/8 features complete. Milestone 04-kai-mcp DONE.

F-006 implemented: mcp_connected event type added to KaiAgentEvent union. Event is yielded after MCP connection phase, before streamText(). Contains only names of successfully connected servers. Not emitted when no MCP servers configured. Emitted with empty array when all servers fail.

F-008 validated: Both kai-sdk and backbone builds pass cleanly. All public exports verified (McpServerConfig, KaiAgentOptions.mcpServers, mcp_connected event type).

## Specs Path
D:\sources\codr.studio\cia-prime-care\agentic-backbone\packages\kai-sdk\milestones\04-kai-mcp

## Environment
- Stack: Node.js, TypeScript (ES2022, ESM), npm workspaces monorepo
- Package: packages/kai-sdk (@agentic-backbone/kai-sdk)
- Dev: npm run dev (tsc --watch) no workspace kai-sdk
- Build: npm run build --workspace=packages/kai-sdk
- Build backbone: npm run build --workspace=apps/backbone
- No test framework configured

## Features

- [x] F-001 MCP dependency — Adicionar @ai-sdk/mcp ao package.json
- [x] F-002 MCP types — McpServerConfig interface + mcpServers em KaiAgentOptions
- [x] F-003 MCP client lifecycle — Criar/fechar MCP clients em runKaiAgent()
- [x] F-004 Tool merging with priority — Mergear MCP tools com codingTools (coding tem prioridade)
- [x] F-005 Graceful failure — Falha de conexão emite warning e continua
- [x] F-006 mcp_connected event — Novo evento tipado em KaiAgentEvent
- [x] F-007 Backbone KAI provider integration — Propagar mcpServers no provider
- [x] F-008 Build validation — Build completo sem erros (kai-sdk + backbone)

## Architecture Decisions

1. **Única dependência nova**: @ai-sdk/mcp — usar createMCPClient(), sem implementação MCP custom
2. **Lifecycle**: MCP clients criados 1x no início de runKaiAgent(), fechados no finally block
3. **Prioridade de tools**: codingTools > MCP tools (spread: { ...mcpTools, ...codingTools })
4. **Graceful degradation**: Server indisponível → console.warn + continua sem ele. Try/catch per-server no loop
5. **Sem reconexão automática**: Se um server cair mid-session, tools dele param de funcionar
6. **Sem OAuth**: Apenas HTTP com headers fixos e stdio
7. **Sem MCP resources/prompts**: Apenas tools do protocolo MCP
8. **Transport mapping**: McpServerConfig.transport.type "http" → MCPTransportConfig, "stdio" → Experimental_StdioMCPTransport (custom MCPTransport from @ai-sdk/mcp/mcp-stdio)
9. **Backbone integration**: toMcpServerConfigs() converte Record<string, unknown> (formato Backbone) para McpServerConfig[] (formato KAI SDK). Apenas entries com transport válido (http/stdio) são incluídas. In-process SDK MCP servers são silenciosamente ignorados.
10. **mcp_connected event**: Emitido após fase de conexão MCP, antes de streamText(). Contém apenas nomes dos servers que conectaram com sucesso. Não emitido se nenhum MCP server configurado. Emitido com array vazio se todos falharem.

## Files Modified

### packages/kai-sdk/
- `package.json` — adicionar @ai-sdk/mcp dependency ✅
- `src/types.ts` — McpServerConfig, mcpServers em KaiAgentOptions, mcp_connected event ✅
- `src/agent.ts` — MCP client lifecycle, tool merging, graceful failure, mcp_connected yield ✅
- `src/index.ts` — exportar McpServerConfig ✅

### apps/backbone/
- `src/agent/providers/kai.ts` — toMcpServerConfigs() + propagar mcpServers para runKaiAgent() ✅

## Session Notes
- Session 1 (Initializer): Harness criado para onda 04-kai-mcp. 8 features, PRP único e bem definido.
- Session 2 (CC): F-001 implementada. @ai-sdk/mcp@^1.0.21 adicionado.
- Session 3 (CC): F-002 implementada. McpServerConfig interface com transport union (http|stdio), mcpServers opcional em KaiAgentOptions, tipo exportado no index.ts. Build passa limpo.
- Session 4 (CC): F-003 implementada. MCP client lifecycle em runKaiAgent(): imports createMCPClient + MCPClient de @ai-sdk/mcp e StdioMCPTransport de @ai-sdk/mcp/mcp-stdio. Helper createMcpTransport() mapeia McpServerConfig para transport correto. Loop cria clients, coleta tools via client.tools(). Finally block fecha todos os clients. Tool merge já implementado com spread order (mcpTools primeiro, codingTools sobrescrevem). Build passa limpo (kai-sdk + backbone). Próxima: F-004 Tool merging with priority.
- Session 5 (CC): F-004 já estava implementada (confirmado todos os testes). F-005 implementada: try/catch per-server no loop de criação de MCP clients, console.warn com nome do server e mensagem de erro. F-007 implementada: toMcpServerConfigs() converte Record<string,unknown> para McpServerConfig[], importa McpServerConfig do SDK, propaga mcpServers para runKaiAgent() com spread condicional. Build limpo (kai-sdk + backbone). Próxima: F-006 mcp_connected event.
- Session 6 (CC): F-006 implementada: mcp_connected event type adicionado ao KaiAgentEvent union em types.ts. Em agent.ts, connectedServers[] rastreia servers que conectaram com sucesso, yield emite evento após loop de conexão MCP. F-008 validada: builds passam, exports verificados. MILESTONE COMPLETO — 8/8 features.