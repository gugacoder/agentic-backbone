# KAI SDK — Better KAY (Milestone 01)
## Agent Harness Progress

---

## Current Status

**Phase:** Implementing — F-001, F-002 done, working through feature list.
**Features:** 13 total (2 passing, 11 remaining)
**Build:** Compilando (7 tools — 6 existentes + ListDir + novos tipos KaiAgentEvent)

---

## Specs Path

```
milestones/01-better-kay/PRP.md
```

---

## Environment

- **Stack:** Node.js (ESM), Vercel AI SDK v4, Zod v3, OpenRouter
- **Package manager:** npm (workspaces monorepo)
- **Build:** `npm run build --workspace=packages/kai-sdk` (tsc)
- **Dev:** `npm run dev` (tsc --watch) no workspace kai-sdk
- **No tests:** Projeto nao tem framework de testes configurado

---

## Features

- [x] F-001: KaiAgentEvent types expansion (priority 1) ✓ 2026-02-16
- [x] F-002: T08 — ListDir tool (priority 2) ✓ 2026-02-16
- [ ] F-003: T07 — MultiEdit tool (priority 3)
- [ ] F-004: T05+T06 — TodoWrite + TodoRead tools (priority 4, depends: F-001)
- [ ] F-005: T09 — Diagnostics tool (priority 5)
- [ ] F-006: T01 — AskUser tool (priority 6, depends: F-001)
- [ ] F-007: T02 — WebFetch tool (priority 7)
- [ ] F-008: T03 — WebSearch tool (priority 8)
- [ ] F-009: T04 — Task sub-agente tool (priority 9)
- [ ] F-010: T10 — Batch tool (priority 10)
- [ ] F-011: T11 — ApplyPatch tool (priority 11)
- [ ] F-012: T12 — CodeSearch tool (priority 12)
- [ ] F-013: Tool registry final + build validation (priority 13, depends: all)

---

## Architecture Decisions

1. **Padrao de tool:** Todas as novas tools seguem o mesmo padrao das 6 existentes — arquivo `.ts` em `src/tools/`, exportando `tool()` do Vercel AI SDK com schema Zod.
2. **Novos eventos:** `ask_user` e `todo_update` adicionados ao tipo `KaiAgentEvent` em `src/types.ts`.
3. **Estado de sessao:** TodoWrite/TodoRead compartilham estado em memoria (closure ou modulo-level).
4. **Providers plugaveis:** WebSearch e CodeSearch nao hardcodam providers — recebem via KaiAgentOptions ou factory.
5. **AskUser callback:** Mecanismo de pergunta ao usuario via callback injetavel (nao polling).
6. **Sub-agente fire-and-forget:** Task lanca `runKaiAgent()` internamente, sem coordenacao bidirecional.
7. **Atomicidade MultiEdit:** Todas edicoes validadas antes de aplicar qualquer uma.
8. **Batch sem recursao:** Batch dentro de Batch e rejeitado.
9. **Output limit:** Ferramentas respeitam 50KB max output.
10. **ESM-only:** Imports com extensao `.js`, sem CommonJS.

---

## Session Notes

Session 1 (Initializer): Harness criado para milestone 01-better-kay
- features.json com 13 features (todas failing)
- progress.txt criado
- agent-setup.sh bootstrap script criado
- PRP decomposed: 12 novas ferramentas + 1 feature de tipos + 1 validacao final = 13 features

Session 2 (Coding Agent): F-001 KaiAgentEvent types expansion
- Converted KaiAgentEvent from single interface to discriminated union type
- Added `ask_user` event: `{ type: "ask_user", question: string, options?: string[] }`
- Added `todo_update` event: `{ type: "todo_update", todos: KaiTodoItem[] }`
- Created KaiTodoItem interface: `{ id, content, status, priority }`
- Exported KaiTodoItem from src/index.ts
- Verified backward compatibility with backbone consumer (kai.ts uses `as AgentEvent` cast)
- Build passes cleanly
- Next priority: F-002 (ListDir tool)

Session 3 (Coding Agent): F-002 ListDir tool
- Created src/tools/list-dir.ts with listDirTool export
- Recursive tree builder with tree-drawing connectors (├──, └──, │)
- Parameters: path (required, z.string()), depth (optional, default 3), ignore (optional, default node_modules/.git/dist/build)
- Directories sorted first, then files, alphabetically within groups
- Dirs marked with trailing /
- Depth limiting: stops recursion at maxDepth
- Ignore filtering: excludes entries matching names in ignore array
- 50KB output limit with truncation
- Registered as ListDir in codingTools (src/tools/index.ts)
- Functional smoke test passed: tree renders correctly, depth limiting works
- Build passes cleanly
- Next priority: F-003 (MultiEdit tool)
