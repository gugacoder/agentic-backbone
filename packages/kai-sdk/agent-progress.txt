# KAI SDK — Better KAY (Milestone 01)
## Agent Harness Progress

---

## Current Status

**Phase:** Implementing — F-001 through F-005 done, working through feature list.
**Features:** 13 total (5 passing, 8 remaining)
**Build:** Compilando (11 tools — 6 existentes + ListDir + MultiEdit + TodoWrite + TodoRead + Diagnostics + novos tipos KaiAgentEvent)

---

## Specs Path

```
milestones/01-better-kay/PRP.md
```

---

## Environment

- **Stack:** Node.js (ESM), Vercel AI SDK v4, Zod v3, OpenRouter
- **Package manager:** npm (workspaces monorepo)
- **Build:** `npm run build --workspace=packages/kai-sdk` (tsc)
- **Dev:** `npm run dev` (tsc --watch) no workspace kai-sdk
- **No tests:** Projeto nao tem framework de testes configurado

---

## Features

- [x] F-001: KaiAgentEvent types expansion (priority 1) ✓ 2026-02-16
- [x] F-002: T08 — ListDir tool (priority 2) ✓ 2026-02-16
- [x] F-003: T07 — MultiEdit tool (priority 3) ✓ 2026-02-16
- [x] F-004: T05+T06 — TodoWrite + TodoRead tools (priority 4, depends: F-001) ✓ 2026-02-16
- [x] F-005: T09 — Diagnostics tool (priority 5) ✓ 2026-02-16
- [ ] F-006: T01 — AskUser tool (priority 6, depends: F-001)
- [ ] F-007: T02 — WebFetch tool (priority 7)
- [ ] F-008: T03 — WebSearch tool (priority 8)
- [ ] F-009: T04 — Task sub-agente tool (priority 9)
- [ ] F-010: T10 — Batch tool (priority 10)
- [ ] F-011: T11 — ApplyPatch tool (priority 11)
- [ ] F-012: T12 — CodeSearch tool (priority 12)
- [ ] F-013: Tool registry final + build validation (priority 13, depends: all)

---

## Architecture Decisions

1. **Padrao de tool:** Todas as novas tools seguem o mesmo padrao das 6 existentes — arquivo `.ts` em `src/tools/`, exportando `tool()` do Vercel AI SDK com schema Zod.
2. **Novos eventos:** `ask_user` e `todo_update` adicionados ao tipo `KaiAgentEvent` em `src/types.ts`.
3. **Estado de sessao:** TodoWrite/TodoRead compartilham estado em memoria (closure ou modulo-level).
4. **Providers plugaveis:** WebSearch e CodeSearch nao hardcodam providers — recebem via KaiAgentOptions ou factory.
5. **AskUser callback:** Mecanismo de pergunta ao usuario via callback injetavel (nao polling).
6. **Sub-agente fire-and-forget:** Task lanca `runKaiAgent()` internamente, sem coordenacao bidirecional.
7. **Atomicidade MultiEdit:** Todas edicoes validadas antes de aplicar qualquer uma.
8. **Batch sem recursao:** Batch dentro de Batch e rejeitado.
9. **Output limit:** Ferramentas respeitam 50KB max output.
10. **ESM-only:** Imports com extensao `.js`, sem CommonJS.

---

## Session Notes

Session 1 (Initializer): Harness criado para milestone 01-better-kay
- features.json com 13 features (todas failing)
- progress.txt criado
- agent-setup.sh bootstrap script criado
- PRP decomposed: 12 novas ferramentas + 1 feature de tipos + 1 validacao final = 13 features

Session 2 (Coding Agent): F-001 KaiAgentEvent types expansion
- Converted KaiAgentEvent from single interface to discriminated union type
- Added `ask_user` event: `{ type: "ask_user", question: string, options?: string[] }`
- Added `todo_update` event: `{ type: "todo_update", todos: KaiTodoItem[] }`
- Created KaiTodoItem interface: `{ id, content, status, priority }`
- Exported KaiTodoItem from src/index.ts
- Verified backward compatibility with backbone consumer (kai.ts uses `as AgentEvent` cast)
- Build passes cleanly
- Next priority: F-002 (ListDir tool)

Session 3 (Coding Agent): F-002 ListDir tool
- Created src/tools/list-dir.ts with listDirTool export
- Recursive tree builder with tree-drawing connectors
- Parameters: path (required), depth (optional, default 3), ignore (optional, default node_modules/.git/dist/build)
- Directories sorted first, then files, alphabetically within groups
- Depth limiting, ignore filtering, 50KB output limit with truncation
- Registered as ListDir in codingTools
- Build passes cleanly
- Next priority: F-003 (MultiEdit tool)

Session 4 (Coding Agent): F-003 MultiEdit tool
- Created src/tools/multi-edit.ts with multiEditTool export
- Parameters: file_path (required, z.string()), edits (required, array of { old_string, new_string, replace_all? })
- Atomicity: edits applied sequentially to in-memory content; if any old_string not found, returns early without writing to disk
- Uniqueness check: if old_string appears multiple times and replace_all is false, rejects with error
- Reuses same logic pattern as Edit tool
- Registered as MultiEdit in codingTools (8 tools total)
- Functional smoke test passed: sequential edits, atomic rollback on failure, replace_all
- Build passes cleanly
- Next priority: F-004 (TodoWrite + TodoRead tools) or F-005 (Diagnostics tool)

Session 5 (Coding Agent): F-004 TodoWrite + TodoRead tools
- Created src/tools/todo.ts with todoWriteTool and todoReadTool exports
- Module-level state: `currentTodos: KaiTodoItem[]` shared between both tools
- TodoWrite: accepts `todos` array with Zod schema (id, content, status enum, priority enum)
- TodoWrite replaces entire list on each call, returns summary with counts
- TodoRead: no parameters, returns formatted list with status icons (○/◐/●) and priority tags
- TodoRead returns "Nenhuma tarefa registrada." when list is empty
- Helper exports: resetTodoState() for testing, getTodos() for consumers
- Uses KaiTodoItem type from types.ts (defined in F-001)
- Registered as TodoWrite and TodoRead in codingTools (10 tools total)
- Build passes cleanly
- Next priority: F-005 (Diagnostics tool)

Session 6 (Coding Agent): F-005 Diagnostics tool
- Created src/tools/diagnostics.ts with diagnosticsTool export
- Wrapper over child_process.exec that runs diagnostic commands (tsc, eslint, etc.)
- Parameters: command (optional, default "npx tsc --noEmit"), file_path (optional, filters errors to file)
- Combines stdout + stderr, normalizes path separators for cross-platform file_path matching
- Returns "Nenhum erro encontrado." when clean (exit code 0, no output)
- Handles edge cases: exitCode != 0 with no output, file_path filtering with no matches
- Output truncated at 50KB limit
- Registered as Diagnostics in codingTools (11 tools total)
- Build passes cleanly
- Next priority: F-006 (AskUser tool)
